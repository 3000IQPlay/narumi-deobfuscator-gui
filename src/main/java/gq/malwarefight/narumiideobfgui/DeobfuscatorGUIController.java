package gq.malwarefight.narumiideobfgui;

import gq.malwarefight.narumiideobfgui.deobfuscatorutils.DeobfuscatorRegistry;
import javafx.fxml.FXML;
import javafx.scene.control.CheckBox;
import javafx.scene.control.Label;
import javafx.scene.control.TextField;
import javafx.scene.layout.VBox;
import javafx.stage.FileChooser;
import org.objectweb.asm.ClassReader;
import uwu.narumi.deobfuscator.Deobfuscator;
import uwu.narumi.deobfuscator.transformer.ComposedTransformer;
import uwu.narumi.deobfuscator.transformer.Transformer;

import java.io.File;
import java.io.FileNotFoundException;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.HashMap;

public class DeobfuscatorGUIController {

    private final HashMap<CheckBox, Transformer> deobfuscatorHashMap = new HashMap<>();
    private boolean stateToToggleTo = true;

    @FXML
    public TextField inputName;
    @FXML
    public TextField outputName;
    @FXML
    public VBox buttonContainer;
    @FXML
    public Label result;
    @FXML
    protected void chooseInputFile() {
        FileChooser fileChooser = new FileChooser();
        fileChooser.setInitialDirectory(new File(System.getProperty("user.dir")));
        fileChooser.getExtensionFilters().addAll(
                new FileChooser.ExtensionFilter("Jar Files", "*.jar", "*.zip"),
                new FileChooser.ExtensionFilter("Other Files", "*.*")
        );
        File input = fileChooser.showOpenDialog(DeobfuscatorGUIApp.stage);
        if (input == null) {
            return;
        }
        inputName.setText(input.getPath());
    }

    @FXML
    protected void chooseOutputFile() {
        FileChooser fileChooser = new FileChooser();
        fileChooser.setInitialDirectory(new File(System.getProperty("user.dir")));
        fileChooser.getExtensionFilters().addAll(
                new FileChooser.ExtensionFilter("Jar Files", "*.jar", "*.zip"),
                new FileChooser.ExtensionFilter("Other Files", "*.*")
        );
        File output = fileChooser.showSaveDialog(DeobfuscatorGUIApp.stage);
        if (output == null) {
            return;
        }
        String path = output.getPath();
        outputName.setText(path);
    }

    @FXML
    public void initialize() {
        if (!DeobfuscatorGUIApp.useRaw) {
            for (ComposedTransformer composedTransformer : DeobfuscatorRegistry.composedTransformers) {
                CheckBox box = new CheckBox(composedTransformer.name());
                buttonContainer.getChildren().add(box);
                deobfuscatorHashMap.put(box, composedTransformer);
            }
        } else {
            for (Transformer transformer: DeobfuscatorRegistry.rawDeobfuscators) {
                CheckBox box = new CheckBox(transformer.name());
                buttonContainer.getChildren().add(box);
                deobfuscatorHashMap.put(box, transformer);
            }
        }
    }

    @FXML
    protected void deobfuscate() {
        if (inputName.getText() == null || outputName.getText() == null || inputName.getText().isBlank() || outputName.getText().isBlank()){
            result.setText("You need to specify both input and output files!");
            return;
        }
        if (!result.getText().equals("")) {
            result.setText("");
        }
        ArrayList<Transformer> usedTransformers = new ArrayList<>();
        deobfuscatorHashMap.forEach((checkBox, transformer) -> {
            if (checkBox.isSelected()) {
                usedTransformers.add(transformer);
            }
        });
        Transformer[] transformers = new Transformer[usedTransformers.size()];
        usedTransformers.toArray(transformers);
        try {
            Deobfuscator.builder()
                    .input(Path.of(inputName.getText()))
                    .output(Path.of(outputName.getText()))
                    .transformers(transformers)
                    .classReaderFlags(ClassReader.SKIP_FRAMES)
                    .classWriterFlags(0)
                    .consoleDebug()
                    .build()
                    .start();
        } catch (FileNotFoundException e) {
            result.setText("One or both of the files don't exist");
            return;
        }
        result.setText("Deobfuscation complete");
    }

    @FXML
    public void toggleAll() {
        for (CheckBox box: deobfuscatorHashMap.keySet()) {
            box.setSelected(stateToToggleTo);
        }
        stateToToggleTo = !stateToToggleTo;
    }
}